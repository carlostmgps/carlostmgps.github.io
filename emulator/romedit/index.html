<html>
<head>
  <title>OnlineGBRomEditor</title>
</head>
<body>
  <input type='file' accept='.gb' id=fileinput onchange='openFile(event)'> <br> PC:<input type="number" id="pc"> <br> <button onclick="downloadrom()">DownloadModifiedRom</button>
  <div id=dbg>
    <pre id=out></pre>
  </div>
</body>
<script>
function ascii(c){
  return ".................................!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.€.‚ƒ„…†‡ˆ‰Š‹Œ.Ž..‘’“”•–—˜™š›œ.žŸ ¡¢£¤¥¦§¨©ª«¬.®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿ".charAt(c)
  .replace(/</g, '&lt;').replace(/>/g, '&gt;')
}

var bootCode = "31 FE FF AF 21 FF 9F 32 CB 7C 20 FB 21 26 FF 0E 11 3E 80 32 E2 0C 3E F3 E2 32 3E 77 77 3E FC E0 47 11 04 01 21 10 80 1A CD 95 00 CD 96 00 13 7B FE 34 20 F3 11 D8 00 06 08 1A 13 22 23 05 20 F9 3E 19 EA 10 99 21 2F 99 0E 0C 3D 28 08 32 0D 20 F9 2E 0F 18 F3 67 3E 64 57 E0 42 3E 91 E0 40 04 1E 02 0E 0C F0 44 FE 90 20 FA 0D 20 F7 1D 20 F2 0E 13 24 7C 1E 83 FE 62 28 06 1E C1 FE 64 20 06 7B E2 0C 3E 87 E2 F0 42 90 E0 42 15 20 D2 05 20 4F 16 20 18 CB 4F 06 04 C5 CB 11 17 C1 CB 11 17 05 20 F5 22 23 22 23 C9 CE ED 66 66 CC 0D 00 0B 03 73 00 83 00 0C 00 0D 00 08 11 1F 88 89 00 0E DC CC 6E E6 DD DD D9 99 BB BB 67 63 6E 0E EC CC DD DC 99 9F BB B9 33 3E 3C 42 B9 A5 B9 A5 42 3C 21 04 01 11 A8 00 1A 13 BE 20 FE 23 7D FE 34 20 F5 06 19 78 86 23 05 20 FB 86 20 FE 3E 01 E0 50".split(" ").map(x => parseInt(x,16))
function f(a,l) {return ("0000"+a.toString(16).toUpperCase()).slice(-l||-2)}
var inputpc = document.getElementById("pc");
inputpc.addEventListener('input',
    function () {
      PC = parseInt(inputpc.value,10)
    }
);
function toBuffer(uint8){
  return uint8.buffer
}
function dl(name, byte) {
    var blob = new Blob([byte], {type: "application/octet-stream"});
    var link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    var fileName = name;
    link.download = fileName;
    link.click();
};
function downloadrom(){
  if (ROM.length > 0) {
    buf = toBuffer(ROM)
    dl("createdrom.gb",buf)
  }else{
    alert("Error:ROM is empty!")
  }
}
var ROM = new Uint8Array();
var openFile = function(event) {
  var input = event.target;
  var reader = new FileReader();
  reader.onload = function(){
    console.log(reader.result)
    ROM = new Uint8Array(reader.result);
    console.log(ROM)
    //Overwrite first page with bootcode
    for (var i=0;i<256;i++) ROM[i]=bootCode[i];
  };
  reader.readAsArrayBuffer(input.files[0]);
};

function getData(adr){
  if (adr > ROM.length-1) { return 0 }
  if (adr < 0) { return 0 }
  return ROM[adr]
}

var PC = 0;
var debugData=function(){
  var debugOffset = (PC&0xFF00) - 0x0150;
  var debug = "";
  for (var j=0;j<60;j++) {
    
    debug+= "$"+f(debugOffset + j*16,4)+"   "
    for (var i=0;i<16;i++) {
      var q=i+j*16 + debugOffset;
      if (String(f(q,4)).includes("-")) { debug+="<span title='$"+ "Undefined" +"'" } else {
        debug+="<span title='$"+ f(q,4) +"'"
      }
      debug+= PC==q ? " style='color:red'>":">"
      debug+=f(getData(q))+"</span>"
      debug+=(i==7?"|":" ");
    }
    debug+="|  "
    for (var i=0;i<16;i++) {
      var c=getData(i+j*16 + debugOffset)
      debug+= ascii(c);
    }
    
    
    debug+="\n"
  }
  document.getElementById('out').innerHTML=debug;
  
};
setInterval(debugData,1000);
</script>
</html>
